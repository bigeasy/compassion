<!DOCTYPE html>

<html>
<head>
  <title>merger.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="channel.bin.js.html">
                  channel.bin.js
                </a>


                <a class="source" href="channel.js.html">
                  channel.js
                </a>


                <a class="source" href="merger.js.html">
                  merger.js
                </a>


                <a class="source" href="reader.js.html">
                  reader.js
                </a>


                <a class="source" href="recorder.js.html">
                  recorder.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>merger.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> cadence = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cadence'</span>)

<span class="hljs-keyword">var</span> departure = <span class="hljs-built_in">require</span>(<span class="hljs-string">'departure'</span>)

<span class="hljs-keyword">var</span> rescue = <span class="hljs-built_in">require</span>(<span class="hljs-string">'rescue'</span>)

<span class="hljs-keyword">var</span> Procession = <span class="hljs-built_in">require</span>(<span class="hljs-string">'procession'</span>)

<span class="hljs-keyword">var</span> Destructor = <span class="hljs-built_in">require</span>(<span class="hljs-string">'destructible'</span>)

<span class="hljs-keyword">var</span> interrupt = <span class="hljs-built_in">require</span>(<span class="hljs-string">'interrupt'</span>).createInterrupter(<span class="hljs-string">'compassion.channel'</span>)

<span class="hljs-keyword">var</span> Splitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'procession/splitter'</span>)

<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>)

<span class="hljs-keyword">var</span> Signal = <span class="hljs-built_in">require</span>(<span class="hljs-string">'signal'</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Merger</span> (<span class="hljs-params">kibitzer, channel</span>) </span>{
    <span class="hljs-keyword">this</span>.replay = <span class="hljs-keyword">new</span> Procession
    <span class="hljs-keyword">this</span>.play = <span class="hljs-keyword">new</span> Procession
    <span class="hljs-keyword">this</span>.ready = <span class="hljs-keyword">new</span> Signal
    <span class="hljs-keyword">this</span>._destructor = <span class="hljs-keyword">new</span> Destructor(<span class="hljs-string">'merger'</span>)
    <span class="hljs-keyword">this</span>._destructor.markDestroyed(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">this</span>._kibitzer = kibitzer
    <span class="hljs-keyword">this</span>._channel = channel
}

Merger.prototype.destroy = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>._destructor.destroy()
}

</pre></div></div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>TODO In order to play long running government you’re going to have to consume
the ping messages. On the other hand, you might have an application that is
generating a lot of application log records, so you can’t simply move through
the paxos log and neglect the application log.</p>
<p>Rather than pulling, you might read though and push into two separate
queues, but trying to keept he queues full made us choose pull in the first
place.</p>
<p>We can read though the log and build the atomic log. We know that events
entered into the log will be consumed soon after they materialize in the log.
Thus, we can push those events onto a queue. There’s no way for us to reach
an entry boundary without already having materialized the entry.</p>
<p>Any records or requests can be played as they are encountered.</p>

            </div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Merger.prototype.merge = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async</span>) </span>{
    <span class="hljs-keyword">var</span> chatter = <span class="hljs-keyword">this</span>._chatter = <span class="hljs-keyword">this</span>._channel.chatter.shifter()
    <span class="hljs-keyword">var</span> replay = <span class="hljs-keyword">this</span>.replay.shifter()
    <span class="hljs-keyword">this</span>.ready.unlatch()

    <span class="hljs-keyword">this</span>._destructor.addDestructor(<span class="hljs-string">'chatter'</span>, chatter, <span class="hljs-string">'destroy'</span>)
    <span class="hljs-keyword">this</span>._destructor.addDestructor(<span class="hljs-string">'replay'</span>, replay, <span class="hljs-string">'destroy'</span>)

</pre></div></div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>var chatter = this._channel.chatter.shifter()</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> outboxes = {
        <span class="hljs-attr">paxos</span>: <span class="hljs-keyword">this</span>._kibitzer.paxos.outbox.shifter(),
        <span class="hljs-attr">islander</span>: <span class="hljs-keyword">this</span>._kibitzer.islander.outbox.shifter()
    }
    <span class="hljs-keyword">var</span> log = <span class="hljs-keyword">this</span>._kibitzer.paxos.log.shifter()
    <span class="hljs-keyword">async</span>([<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>._channel.getProperties(<span class="hljs-keyword">this</span>._kibitzer.paxos.id, <span class="hljs-keyword">async</span>())
    }, rescue(<span class="hljs-regexp">/^conduit#endOfStream/m</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
        <span class="hljs-keyword">return</span> [ <span class="hljs-keyword">async</span>.break ]
    })], <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            replay.dequeue(<span class="hljs-keyword">async</span>())
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entry</span>) </span>{
            departure.raise(entry.source, <span class="hljs-string">'kibitz'</span>)
            <span class="hljs-keyword">var</span> envelope = entry.$envelope
            <span class="hljs-keyword">switch</span> (envelope.method) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">'bootstrap'</span>:
                <span class="hljs-built_in">console</span>.log(envelope)
                properties.url = envelope.body.properties.url
                departure.raise(properties, envelope.body.properties)
                <span class="hljs-keyword">this</span>._kibitzer.replay(envelope)
                <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">case</span> <span class="hljs-string">'join'</span>:
                <span class="hljs-built_in">console</span>.log(envelope)
</pre></div></div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>properties.url = envelope.body.properties.url
departure.raise(properties, envelope.body.properties)</p>

            </div>

            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">this</span>._kibitzer.replay(envelope)
                <span class="hljs-keyword">break</span>
            }
        })
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> loop = <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            replay.dequeue(<span class="hljs-keyword">async</span>())
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entry</span>) </span>{
            <span class="hljs-built_in">console</span>.log(entry)
            <span class="hljs-keyword">if</span> (entry == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> [ loop.break ]
            }
            <span class="hljs-keyword">var</span> envelope = entry.$envelope
            <span class="hljs-keyword">switch</span> (entry.source) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">'colleague'</span>:
                <span class="hljs-keyword">switch</span> (envelope.method) {
                <span class="hljs-keyword">case</span> <span class="hljs-string">'boundary'</span>:
                    <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                        <span class="hljs-keyword">if</span> (envelope.entry != <span class="hljs-literal">null</span>) {
                            <span class="hljs-keyword">var</span> entry = log.shift()
                            departure.raise(entry.promise, envelope.entry)
                            <span class="hljs-keyword">this</span>._channel.read.enqueue({
                                <span class="hljs-attr">module</span>: <span class="hljs-string">'colleague'</span>,
                                <span class="hljs-attr">method</span>: <span class="hljs-string">'entry'</span>,
                                <span class="hljs-attr">body</span>: entry
                            }, <span class="hljs-keyword">async</span>())
                        }
                    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                        chatter.join(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entry</span>) </span>{
                            <span class="hljs-keyword">return</span> entry.id == envelope.id
                        }, <span class="hljs-keyword">async</span>())
                    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">envelope</span>) </span>{
                        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'BOUNDARY FOUND'</span>, envelope)
                    })
                    <span class="hljs-keyword">break</span>
                <span class="hljs-keyword">case</span> <span class="hljs-string">'invoke'</span>:
                    <span class="hljs-keyword">this</span>._channel.read.enqueue({
                        <span class="hljs-attr">module</span>: <span class="hljs-string">'colleague'</span>,
                        <span class="hljs-attr">method</span>: <span class="hljs-string">'invoke'</span>,
                        <span class="hljs-attr">id</span>: envelope.id,
                        <span class="hljs-attr">body</span>: envelope.body
                    }, <span class="hljs-keyword">async</span>())
                    <span class="hljs-keyword">break</span>
                <span class="hljs-keyword">case</span> <span class="hljs-string">'record'</span>:
                    <span class="hljs-keyword">this</span>._channel.read.enqueue({
                        <span class="hljs-attr">module</span>: <span class="hljs-string">'colleague'</span>,
                        <span class="hljs-attr">method</span>: <span class="hljs-string">'record'</span>,
                        <span class="hljs-attr">id</span>: envelope.id,
                        <span class="hljs-attr">body</span>: envelope.body
                    }, <span class="hljs-keyword">async</span>())
                    <span class="hljs-keyword">break</span>
                }
                <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">case</span> <span class="hljs-string">'kibitz'</span>:
                <span class="hljs-keyword">this</span>._kibitzer.replay(envelope)
                <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">case</span> <span class="hljs-string">'paxos'</span>:
                departure.raise(outboxes.paxos.shift(), envelope)
                <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">case</span> <span class="hljs-string">'islander'</span>:
                departure.raise(outboxes.islander.shift(), envelope)
                <span class="hljs-keyword">break</span>
            }
        })()
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'DONE'</span>)
    })
})

<span class="hljs-built_in">module</span>.exports = Merger

</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
