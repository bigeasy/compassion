<!DOCTYPE html>

<html>
<head>
  <title>rendezvous.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="envoy.js.html">
                  envoy.js
                </a>


                <a class="source" href="rendezvous.js.html">
                  rendezvous.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>rendezvous.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>)
<span class="hljs-keyword">var</span> abend = <span class="hljs-built_in">require</span>(<span class="hljs-string">'abend'</span>)
<span class="hljs-keyword">var</span> cadence = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cadence'</span>)
<span class="hljs-keyword">var</span> coalesce = <span class="hljs-built_in">require</span>(<span class="hljs-string">'nascent.coalesce'</span>)
<span class="hljs-keyword">var</span> WildMap = <span class="hljs-built_in">require</span>(<span class="hljs-string">'wildmap'</span>)
<span class="hljs-keyword">var</span> url = <span class="hljs-built_in">require</span>(<span class="hljs-string">'url'</span>)
<span class="hljs-keyword">var</span> coalesce = <span class="hljs-built_in">require</span>(<span class="hljs-string">'nascent.coalesce'</span>)
<span class="hljs-keyword">var</span> Spigot = <span class="hljs-built_in">require</span>(<span class="hljs-string">'conduit/spigot'</span>)
<span class="hljs-keyword">var</span> Staccato = <span class="hljs-built_in">require</span>(<span class="hljs-string">'staccato'</span>)</pre></div></div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Evented message queue.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Procession = <span class="hljs-built_in">require</span>(<span class="hljs-string">'procession'</span>)

<span class="hljs-keyword">var</span> Multiplexer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'conduit/multiplexer'</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Rendezvous</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>._connections = <span class="hljs-keyword">new</span> WildMap
    <span class="hljs-keyword">this</span>.paths = []
}

Rendezvous.prototype.listener = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">callback, request, response</span>) </span>{
    <span class="hljs-keyword">this</span>.middleware(request, response, callback)
}

Rendezvous.prototype.middleware = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">request, response, next</span>) </span>{
    <span class="hljs-keyword">var</span> parsed = url.parse(request.url)
    <span class="hljs-keyword">var</span> path = parsed.path.split(<span class="hljs-string">'/'</span>)
    <span class="hljs-keyword">var</span> connection = <span class="hljs-keyword">this</span>._connections.match(path).pop()
    <span class="hljs-keyword">if</span> (connection) {
        <span class="hljs-keyword">var</span> request = <span class="hljs-keyword">new</span> Request(<span class="hljs-keyword">this</span>, connection, request, response)
        request.consume(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{ <span class="hljs-keyword">if</span> (error) next(error) })
    } <span class="hljs-keyword">else</span> {
        next()
    }
}

Rendezvous.prototype.upgrade = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">request, socket</span>) </span>{
    <span class="hljs-keyword">var</span> path = request.headers[<span class="hljs-string">'sec-conduit-rendezvous-path'</span>]
    <span class="hljs-keyword">if</span> (path == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    <span class="hljs-keyword">var</span> paths = <span class="hljs-keyword">this</span>.paths, connections = <span class="hljs-keyword">this</span>._connections, magazine = <span class="hljs-keyword">this</span>._magazine

    <span class="hljs-keyword">var</span> parts = path.split(<span class="hljs-string">'/'</span>)

    connections.get(parts).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">connection</span>) </span>{
        <span class="hljs-keyword">if</span> (connection.path == path) {
            connection.close.call(<span class="hljs-literal">null</span>)
        }
    })
    <span class="hljs-keyword">var</span> connection = {
        <span class="hljs-attr">path</span>: path,
        <span class="hljs-attr">close</span>: close,
        <span class="hljs-attr">socket</span>: socket,
        <span class="hljs-attr">multiplexer</span>: <span class="hljs-keyword">new</span> Multiplexer(socket, socket)
    }</pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>TODO Instead of <code>abend</code>, some sort of cleanup and recovery.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    connection.multiplexer.listen(abend)
    connections.add(parts, connection)
    paths.push(path)</pre></div></div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>socket.once(‘error’, function () { })</p>

            </div>

            <div class="content"><div class='highlight'><pre>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">close</span> (<span class="hljs-params"></span>) </span>{
        connection.multiplexer.destroy()
        connections.remove(parts, connections.get(path)[<span class="hljs-number">0</span>])
        paths.splice(paths.indexOf(path), <span class="hljs-number">1</span>)
        socket.destroy()
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Request</span> (<span class="hljs-params">rendezvous, connection, request, response</span>) </span>{
    <span class="hljs-keyword">this</span>._rendezvous = rendezvous
    <span class="hljs-keyword">this</span>._connection = connection
    <span class="hljs-keyword">this</span>._request = request
    <span class="hljs-keyword">this</span>._response = response
    <span class="hljs-keyword">this</span>._spigot = <span class="hljs-keyword">new</span> Spigot(<span class="hljs-keyword">this</span>)
}

Request.prototype.fromSpigot = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, envelope</span>) </span>{
    <span class="hljs-keyword">if</span> (envelope == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> []
    }
    <span class="hljs-keyword">switch</span> (envelope.method) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'header'</span>:
        <span class="hljs-keyword">this</span>._response.writeHead(envelope.body.statusCode,
            envelope.body.statusMessage, envelope.body.headers)
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'chunk'</span>:
        <span class="hljs-keyword">this</span>._response.write(envelope.body, <span class="hljs-keyword">async</span>())
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'trailer'</span>:
        <span class="hljs-keyword">this</span>._response.end()
        <span class="hljs-keyword">break</span>
    }
    <span class="hljs-keyword">return</span> []
})</pre></div></div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p><a href="http://stackoverflow.com/a/5426648">http://stackoverflow.com/a/5426648</a></p>

            </div>

            <div class="content"><div class='highlight'><pre>Request.prototype.consume = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async</span>) </span>{
    <span class="hljs-keyword">var</span> location = url.parse(<span class="hljs-keyword">this</span>._request.url)
    <span class="hljs-keyword">var</span> path = location.pathname
    location.pathname = location.pathname.substring(<span class="hljs-keyword">this</span>._connection.path.length)
    location = url.format(location)
    <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>._connection.multiplexer.connect(<span class="hljs-keyword">async</span>())
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">socket</span>) </span>{
        <span class="hljs-keyword">this</span>._spigot.emptyInto(socket.basin)
        <span class="hljs-keyword">this</span>._spigot.requests.enqueue({
            <span class="hljs-attr">module</span>: <span class="hljs-string">'rendezvous'</span>,
            <span class="hljs-attr">method</span>: <span class="hljs-string">'header'</span>,
            <span class="hljs-attr">body</span>: {
                <span class="hljs-attr">httpVersion</span>: <span class="hljs-keyword">this</span>._request.httpVersion,
                <span class="hljs-attr">method</span>: <span class="hljs-keyword">this</span>._request.method,
                <span class="hljs-attr">url</span>: location,
                <span class="hljs-attr">headers</span>: <span class="hljs-keyword">this</span>._request.headers,
                <span class="hljs-attr">actualPath</span>: path,
                <span class="hljs-attr">rawHeaders</span>: coalesce(<span class="hljs-keyword">this</span>._request.rawHeaders, [])
            }
        }, <span class="hljs-keyword">async</span>())
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> readable = <span class="hljs-keyword">new</span> Staccato.Readable(<span class="hljs-keyword">this</span>._request)
        <span class="hljs-keyword">var</span> loop = <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                readable.read(<span class="hljs-keyword">async</span>())
            }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">buffer</span>) </span>{
                <span class="hljs-keyword">if</span> (buffer == <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">return</span> [ loop.break ]
                }
                <span class="hljs-keyword">this</span>._spigot.requests.enqueue({
                    <span class="hljs-attr">module</span>: <span class="hljs-string">'rendezvous'</span>,
                    <span class="hljs-attr">method</span>: <span class="hljs-string">'chunk'</span>,
                    <span class="hljs-attr">body</span>: buffer
                }, <span class="hljs-keyword">async</span>())
            })
        })()
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>._spigot.requests.enqueue({
            <span class="hljs-attr">module</span>: <span class="hljs-string">'rendezvous'</span>,
            <span class="hljs-attr">method</span>: <span class="hljs-string">'trailer'</span>,
            <span class="hljs-attr">body</span>: <span class="hljs-literal">null</span>
        }, <span class="hljs-keyword">async</span>())
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>._spigot.requests.enqueue(<span class="hljs-literal">null</span>, <span class="hljs-keyword">async</span>())
    })
})

Rendezvous.prototype._close = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async</span>) </span>{
    <span class="hljs-keyword">async</span>.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">path</span>) </span>{
        <span class="hljs-keyword">this</span>._connections.get(path.split(<span class="hljs-string">'/'</span>))[<span class="hljs-number">0</span>].socket.end(<span class="hljs-keyword">async</span>())
    })(<span class="hljs-keyword">this</span>.paths)
})

Rendezvous.prototype.close = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">callback</span>) </span>{
    <span class="hljs-keyword">this</span>._close(callback || abend)
}

<span class="hljs-built_in">module</span>.exports = Rendezvous</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
