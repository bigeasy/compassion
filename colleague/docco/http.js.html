<!DOCTYPE html>

<html>
<head>
  <title>http.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="chaperon.js.html">
                  chaperon.js
                </a>


                <a class="source" href="colleague.bin.js.html">
                  colleague.bin.js
                </a>


                <a class="source" href="colleague.js.html">
                  colleague.js
                </a>


                <a class="source" href="http.js.html">
                  http.js
                </a>


                <a class="source" href="ipc.js.html">
                  ipc.js
                </a>


                <a class="source" href="listener.js.html">
                  listener.js
                </a>


                <a class="source" href="middleware.js.html">
                  middleware.js
                </a>


                <a class="source" href="network.js.html">
                  network.js
                </a>


                <a class="source" href="ua.js.html">
                  ua.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>http.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> cadence = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cadence'</span>)
<span class="hljs-keyword">var</span> events = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>)
<span class="hljs-keyword">var</span> Kibitzer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'kibitz'</span>)
<span class="hljs-keyword">var</span> url = <span class="hljs-built_in">require</span>(<span class="hljs-string">'url'</span>)
<span class="hljs-keyword">var</span> abend = <span class="hljs-built_in">require</span>(<span class="hljs-string">'abend'</span>)
<span class="hljs-keyword">var</span> Scheduler = <span class="hljs-built_in">require</span>(<span class="hljs-string">'happenstance'</span>)
<span class="hljs-keyword">var</span> Reactor = <span class="hljs-built_in">require</span>(<span class="hljs-string">'reactor'</span>)
<span class="hljs-keyword">var</span> logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">'prolific.logger'</span>).createLogger(<span class="hljs-string">'compassion.colleague'</span>)
<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>)
<span class="hljs-keyword">var</span> events = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>)
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Colleague</span> (<span class="hljs-params">options</span>) </span>{
    <span class="hljs-keyword">this</span>.kibitzer = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">this</span>._outOfBandNumber = <span class="hljs-number">0</span>
    <span class="hljs-keyword">this</span>._chaperon = options.chaperon
    <span class="hljs-keyword">this</span>._requests = <span class="hljs-keyword">new</span> Reactor({ <span class="hljs-attr">object</span>: <span class="hljs-keyword">this</span>, <span class="hljs-attr">method</span>: <span class="hljs-string">'_request'</span> })
    <span class="hljs-keyword">this</span>.chaperon = <span class="hljs-keyword">new</span> Reactor({ <span class="hljs-attr">object</span>: <span class="hljs-keyword">this</span>, <span class="hljs-attr">method</span>: <span class="hljs-string">'_checkChaperon'</span> })
    <span class="hljs-keyword">this</span>._requests.turnstile.health.turnstiles = <span class="hljs-number">24</span>
    <span class="hljs-keyword">this</span>.messages = <span class="hljs-keyword">new</span> events.EventEmitter
    <span class="hljs-keyword">this</span>.colleagueId = options.colleagueId
    <span class="hljs-keyword">this</span>.islandName = options.islandName
    <span class="hljs-keyword">this</span>._timeout = options.timeout
    <span class="hljs-keyword">this</span>._ping = options.ping
    <span class="hljs-keyword">this</span>._recording = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">this</span>.startedAt = <span class="hljs-built_in">Date</span>.now()
    <span class="hljs-keyword">this</span>.properties = options.properties
    <span class="hljs-keyword">this</span>._ua = options.ua
    <span class="hljs-keyword">this</span>._Date = options.Date || <span class="hljs-built_in">Date</span>
    <span class="hljs-keyword">this</span>.scheduler = <span class="hljs-keyword">new</span> Scheduler({ <span class="hljs-attr">Date</span>: <span class="hljs-keyword">this</span>._Date })
    <span class="hljs-keyword">var</span> properties = options.properties || {}

    <span class="hljs-keyword">var</span> dispatcher = <span class="hljs-keyword">new</span> Dispatcher(<span class="hljs-keyword">this</span>)
    dispatcher.dispatch(<span class="hljs-string">'GET /'</span>, <span class="hljs-string">'index'</span>)
    dispatcher.dispatch(<span class="hljs-string">'GET /health'</span>, <span class="hljs-string">'health'</span>)
    dispatcher.dispatch(<span class="hljs-string">'POST /kibitz'</span>, <span class="hljs-string">'kibitz'</span>)
    dispatcher.dispatch(<span class="hljs-string">'POST /join'</span>, <span class="hljs-string">'join'</span>)
    dispatcher.dispatch(<span class="hljs-string">'POST /bootstrap'</span>, <span class="hljs-string">'bootstrap'</span>)
    dispatcher.dispatch(<span class="hljs-string">'POST /shutdown'</span>, <span class="hljs-string">'shutdown'</span>)
    <span class="hljs-keyword">this</span>.dispatcher = dispatcher

    properties.location = options.conduit
    properties.colleagueId = options.colleagueId
    properties.islandName = options.islandName
    <span class="hljs-keyword">this</span>.kibitzer = <span class="hljs-keyword">new</span> Kibitzer({
        <span class="hljs-attr">id</span>: options.colleagueId,
        <span class="hljs-attr">Date</span>: <span class="hljs-keyword">this</span>._Date,
        <span class="hljs-attr">properties</span>: properties,
        <span class="hljs-attr">timeout</span>: options.timeout,
        <span class="hljs-attr">ping</span>: options.ping,
        <span class="hljs-attr">timerless</span>: options.timerless,
        <span class="hljs-attr">replaying</span>: options.replaying
    })
    <span class="hljs-keyword">this</span>.replaying = options.replaying
}

Colleague.prototype.index = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-string">'Compassion Colleague API\n'</span>
})

Colleague.prototype._setConsumer =  <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">consumer, properties</span>) </span>{
    <span class="hljs-keyword">this</span>._consumer = consumer
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> propertyName <span class="hljs-keyword">in</span> properties) {
        <span class="hljs-keyword">this</span>.kibitzer.properties[propertyName] = properties[propertyName]
    }
    <span class="hljs-keyword">this</span>.kibitzer.on(<span class="hljs-string">'enqueued'</span>, consumer.enqueued.bind(consumer))
}

Colleague.prototype.shutdown = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>.scheduler.shutdown()
    <span class="hljs-keyword">this</span>.kibitzer.shutdown()
}

Colleague.prototype.record = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">name, message</span>) </span>{
    logger.info(<span class="hljs-string">'record'</span>, { <span class="hljs-attr">recording</span>: { <span class="hljs-attr">name</span>: name, <span class="hljs-attr">message</span>: message } })
    <span class="hljs-keyword">this</span>._consumer.replay(name, message)
}

Colleague.prototype.replay = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entry</span>) </span>{
    <span class="hljs-keyword">if</span> (entry.qualified == <span class="hljs-string">'compassion.colleague#record'</span>) {
        <span class="hljs-keyword">this</span>._consumer.replay(entry.recording.name, entry.recording.message)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.kibitzer.replay()
    }
}</pre></div></div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>TODO Break this up somehow, really crufty.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Colleague.prototype.play = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, entry, machine</span>) </span>{
    <span class="hljs-keyword">if</span> (entry.qualifier == <span class="hljs-string">'compassion.colleague'</span> &amp;&amp; entry.level == <span class="hljs-string">'trace'</span>) {
        <span class="hljs-keyword">switch</span> (entry.name) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'bootstrap'</span>:
            logger.trace(<span class="hljs-string">'bootstrap'</span>, { <span class="hljs-attr">request</span>: entry.request, <span class="hljs-attr">cookie</span>: entry.cookie })
            <span class="hljs-keyword">this</span>._createKibitzer(entry.request, entry.cookie, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>)
            <span class="hljs-keyword">this</span>.kibitzer.replay()
            <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">case</span> <span class="hljs-string">'join'</span>:
            logger.trace(<span class="hljs-string">'join'</span>, { <span class="hljs-attr">request</span>: entry.request, <span class="hljs-attr">cookie</span>: entry.cookie })
            <span class="hljs-keyword">this</span>._createKibitzer(entry.request, entry.cookie, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>)
            <span class="hljs-keyword">this</span>.kibitzer.replay()
            <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">case</span> <span class="hljs-string">'publish'</span>:
            <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">try</span> {
                assert.deepEqual(<span class="hljs-keyword">this</span>._recording[<span class="hljs-number">0</span>], {
                    <span class="hljs-attr">entry</span>: entry.entry
                })
                <span class="hljs-keyword">this</span>._recording.shift()
            } <span class="hljs-keyword">catch</span> (e) {
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'r'</span>, <span class="hljs-keyword">this</span>._recording[<span class="hljs-number">0</span>] &amp;&amp; <span class="hljs-keyword">this</span>._recording[<span class="hljs-number">0</span>].entry)
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'l'</span>, entry.entry)
            }
            <span class="hljs-keyword">break</span>
        }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.kibitzer != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">this</span>.kibitzer.play(entry)
    }
    machine.replay(entry)
})

Colleague.prototype.kibitz = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, request</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.kibitzer == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> [ <span class="hljs-literal">null</span> ]
    }
    <span class="hljs-keyword">this</span>.kibitzer.dispatch(request.kibitz, <span class="hljs-keyword">async</span>())
})

Colleague.prototype.publish = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, entry</span>) </span>{
    logger.trace(<span class="hljs-string">'publish'</span>, { <span class="hljs-attr">entry</span>: entry })
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._recording == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">this</span>.kibitzer.publish(entry)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>._recording.push({ <span class="hljs-attr">entry</span>: entry })
    }
    <span class="hljs-keyword">return</span> []
})

Colleague.prototype.oob = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, body</span>) </span>{
    logger.trace(<span class="hljs-string">'oob'</span>, { <span class="hljs-attr">body</span>: body })
    <span class="hljs-keyword">this</span>._consumer.oob(body.name, body.post, <span class="hljs-keyword">async</span>())
})</pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Any error is going to crash. No retry. We are going to ask the current
leader. If the leader is not there or responds with any sort of error code,
we crash. Out-of-band data is supposed to be used to abtain a mirror of an
initial state, probably through an atomic immigration entry processor, so if
the leader is unresponsive, and the government has changed, we’re not going
to be able to wait until things get better. We can’t process the log until
we’re initialized. Deadlock. Crash and start over.</p>
<p>The leader doesn’t necessarily need to be the leader. That is application
dependant. It only needs to have the state information necessary to
initialize the new participant. Unless the application developer wants us to
crash, we’re not going to crash if leadership changes, only if the leader at
the time of immigration has gone away or is unable to respond.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Colleague.prototype.outOfBand = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, name, post</span>) </span>{
    <span class="hljs-keyword">var</span> outOfBandNumber = <span class="hljs-keyword">this</span>._outOfBandNumber++
    logger.trace(<span class="hljs-string">'outOfBandCall'</span>, {
        <span class="hljs-attr">message</span>: {
            <span class="hljs-attr">name</span>: name, <span class="hljs-attr">post</span>: post, <span class="hljs-attr">invocation</span>: outOfBandNumber
        }
   })
    <span class="hljs-keyword">var</span> leaderId = <span class="hljs-keyword">this</span>.kibitzer.legislator.government.majority[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">var</span> properties = <span class="hljs-keyword">this</span>.kibitzer.legislator.properties[leaderId]
    <span class="hljs-keyword">var</span> url = util.format(<span class="hljs-string">'http://%s/oob'</span>, properties.location)
    <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>._ua._ua.fetch({
            <span class="hljs-attr">url</span>: url,
            <span class="hljs-attr">post</span>: {
                <span class="hljs-attr">islandName</span>: <span class="hljs-keyword">this</span>.islandName,
                <span class="hljs-attr">islandId</span>: <span class="hljs-keyword">this</span>.islandId,
                <span class="hljs-attr">colleagueId</span>: leaderId,
                <span class="hljs-attr">name</span>: name,
                <span class="hljs-attr">post</span>: post
            },
            <span class="hljs-attr">raise</span>: <span class="hljs-literal">true</span>
        }, <span class="hljs-keyword">async</span>())
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">result</span>) </span>{
        logger.trace(<span class="hljs-string">'outOfBandReturn'</span>, { <span class="hljs-attr">invocation</span>: outOfBandNumber, <span class="hljs-attr">result</span>: result })
        <span class="hljs-keyword">return</span> [ result ]
    })
})

Colleague.prototype.naturalized = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>.kibitzer.legislator.naturalize()
}

Colleague.prototype.health = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async</span>) </span>{
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">startedAt</span>: <span class="hljs-keyword">this</span>.startedAt,
        <span class="hljs-attr">requests</span>: <span class="hljs-keyword">this</span>._requests.turnstile.health,
        <span class="hljs-attr">islandName</span>: <span class="hljs-keyword">this</span>.islandName,
        <span class="hljs-attr">colleagueId</span>: <span class="hljs-keyword">this</span>.kibitzer.paxos.id,
        <span class="hljs-attr">islandId</span>: <span class="hljs-keyword">this</span>.kibitzer.paxos.islandId,
        <span class="hljs-attr">government</span>: <span class="hljs-keyword">this</span>.kibitzer.paxos.government
    }
})

Colleague.prototype.request = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, type, body</span>) </span>{
    <span class="hljs-keyword">if</span> (!~([ <span class="hljs-string">'health'</span>, <span class="hljs-string">'kibitz'</span>, <span class="hljs-string">'join'</span>, <span class="hljs-string">'bootstrap'</span>, <span class="hljs-string">'shutdown'</span> ]).indexOf(type)) {
        <span class="hljs-keyword">return</span> [ { <span class="hljs-attr">cookie</span>: request.cookie, <span class="hljs-attr">body</span>: <span class="hljs-literal">null</span> } ]
    }
    <span class="hljs-keyword">this</span>[type](body, <span class="hljs-keyword">async</span>())
})

<span class="hljs-built_in">module</span>.exports = Colleague</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
